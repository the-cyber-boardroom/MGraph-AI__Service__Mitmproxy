# Content Filtering Platform: Navigation & Visualization Layer

## LLM Briefing Document - Phase 2

**Version:** v0.7.27  
**Date:** October 14, 2025  
**Status:** Ready for Implementation

---

## Executive Summary

This document describes the next development phase for the content filtering platform's admin interface. The current MVP successfully demonstrates:
- Content filtering via proxy interception (AWS-based)
- Cache-backed performance (22s → 0.6s on cached content)
- Hierarchical storage structure (`sites/{domain}/pages/{path}`)
- Basic admin dashboard for filter control

**This phase adds**: Comprehensive navigation, visualization, and explainability tools to help users understand what content was captured, how it was classified, and why filtering decisions were made.

---

## 1. Context & Current State

### 1.1 Architecture Overview

The system operates as follows:

```
User Browser → Mitmproxy (port 8080) → Service Layer → Cache System
                    ↓
            Admin UI (/mitm-proxy/)
```

**Key Components:**
- **Mitmproxy**: Intercepts HTTP/HTTPS traffic
- **Service Layer**: FastAPI-based Lambda functions that process requests/responses
- **Cache System**: Hierarchical storage using `mgraph_ai_service_cache`
- **WCF Service**: Web Content Filtering - extracts and analyzes HTML structure
- **LLM Classification**: Rates content segments for positivity/negativity

### 1.2 Current Data Structure

The cache stores data hierarchically:

```
sites/
  └── example.com/
      ├── [site metadata]
      └── pages/
          └── about/
              ├── page-entry (metadata)
              └── transformations/
                  ├── html (cached content)
                  ├── text (extracted text)
                  └── ratings (LLM classifications)
```

**Cache Key Formula**: `sites/{domain}/pages/{sanitized_path}`

**Important Implementation Detail**: The system uses URL-based cache keys (not content hashes), enabling deterministic lookup: "Have we seen this URL before?"

### 1.3 Current Admin Interface

Location: `/mitm-proxy/` endpoint

**Existing Features** (as seen in `Proxy__Admin__Service`):
- Static file serving for admin UI
- JSON API endpoint: `/mitm-proxy/admin-ui.json`
- Server info and statistics
- Cookie management display

---

## 2. Problem Statement & User Needs

### 2.1 Two Distinct User Personas

#### **Persona 1: The Developer**
**Need**: "I need to debug the system and verify everything is working correctly."

**Pain Points**:
- Can't see what pages have been cached
- No visibility into cache hit/miss rates
- Hard to verify LLM classifications are accurate
- Cannot inspect raw data structure
- Performance bottlenecks not visible

**Success Criteria**: Full transparency into system operations with detailed technical data.

---

#### **Persona 2: The End User**
**Need**: "I need to understand why content was filtered or shown to me."

**Pain Points**:
- Content appears/disappears with no explanation
- Classification seems arbitrary ("Why was this rated negative?")
- No way to verify filtering accuracy
- Feels like a "black box" making decisions
- Trust issues with automated filtering

**Success Criteria**: Clear, simple explanations of filtering decisions with visual feedback.

---

### 2.2 Core Questions Users Ask

When a page loads with filtered content, users wonder:

1. **"What just happened?"** - Need visibility into filtering actions
2. **"How did you classify this?"** - Need to see LLM reasoning
3. **"Why was this hidden?"** - Need explicit threshold/rating info
4. **"Is this working?"** - Need performance and accuracy metrics
5. **"What have you captured?"** - Need inventory of cached content

---

## 3. Feature Requirements

### 3.1 Enhanced Admin UI - Site/Page Navigation

#### **3.1.1 Site Inventory View**

**Purpose**: Show all websites that have been proxied and cached.

**Visual Design Concept**:
```
┌─────────────────────────────────────────────┐
│ Cached Sites                        [Refresh] │
├─────────────────────────────────────────────┤
│ ▼ example.com                    [23 pages]  │
│   ├── First seen: 2025-10-12                 │
│   ├── Last accessed: 2 minutes ago           │
│   ├── Total requests: 156                    │
│   └── Cache hit rate: 87%                    │
│                                               │
│ ▼ docs.diniscruz.ai              [12 pages]  │
│   ├── First seen: 2025-10-13                 │
│   └── ...                                     │
└─────────────────────────────────────────────┘
```

**Data Requirements**:
- Site domain
- Page count per site
- First/last access timestamps
- Request frequency
- Cache performance (hit/miss ratio)

**Interaction**:
- Expandable/collapsible site entries
- Click site → drill into page list
- Sort by: domain, page count, last accessed, hit rate

---

#### **3.1.2 Page List View**

**Purpose**: Show all pages captured for a selected site.

**Visual Design Concept**:
```
┌─────────────────────────────────────────────────────┐
│ example.com > Pages                     [← Back]     │
├─────────────────────────────────────────────────────┤
│ /                                 [View] [Details]   │
│   └── Cached: Yes | Hits: 45 | Avg load: 0.6s      │
│                                                       │
│ /about                            [View] [Details]   │
│   └── Cached: Yes | Hits: 12 | Avg load: 0.8s      │
│                                                       │
│ /products                         [View] [Details]   │
│   └── Cached: Yes | Hits: 8 | Avg load: 22.3s      │
│       └── ⚠️ Slow first load                         │
└─────────────────────────────────────────────────────┘
```

**Data Requirements**:
- Page URL/path
- Cache status (present/absent)
- Access count
- Average load time (first load vs cached)
- Size metrics
- Last updated timestamp

**Interaction**:
- Click "View" → open page in proxy browser
- Click "Details" → page detail view (see below)
- Visual indicators for slow pages or errors

---

#### **3.1.3 Page Detail View**

**Purpose**: Deep dive into a specific page's cached data and transformations.

**Visual Design Concept**:
```
┌──────────────────────────────────────────────────────┐
│ example.com > Pages > /about               [← Back]  │
├──────────────────────────────────────────────────────┤
│ Cache Entry Details                                   │
│ ├─ Cache ID: 8f3a2b1c-...                            │
│ ├─ Cache Key: sites/example.com/pages/about         │
│ ├─ Cache Hash: a1b2c3d4...                           │
│ └─ Created: 2025-10-13 14:32:11                      │
│                                                       │
│ Performance Metrics                                   │
│ ├─ First Load: 22.3s (via LLM)                       │
│ ├─ Cached Load: 0.6s                                 │
│ ├─ Total Requests: 12                                │
│ └─ Last Accessed: 2 minutes ago                      │
│                                                       │
│ Available Transformations                             │
│ ├─ ▼ HTML (original)           [View] [Download]     │
│ ├─ ▼ Text (extracted)          [View] [Download]     │
│ └─ ▼ Ratings (LLM analysis)    [View] [Download]     │
│                                                       │
│ [View Full Cache JSON] [Refresh Cache Entry]         │
└──────────────────────────────────────────────────────┘
```

**Data Requirements**:
- All cache metadata (ID, key, hash)
- Timestamps (created, last accessed)
- Performance metrics (split by first/cached)
- Available transformation types
- Raw cache entry JSON

**Interaction**:
- Expandable transformation sections
- View transformations inline or download
- Refresh cache entry (re-fetch from origin)
- View raw JSON for debugging

---

### 3.2 Cache Statistics & Performance Metrics

#### **3.2.1 Global Statistics Dashboard**

**Purpose**: High-level overview of cache performance across all sites.

**Visual Design Concept**:
```
┌─────────────────────────────────────────────┐
│ Cache Performance Overview                   │
├─────────────────────────────────────────────┤
│ Total Sites Cached: 15                       │
│ Total Pages Cached: 342                      │
│ Total Requests: 4,521                        │
│                                               │
│ Cache Hit Rate: 87.3%  [████████░░] 87%     │
│ ├─ Cache Hits: 3,946                         │
│ └─ Cache Misses: 575                         │
│                                               │
│ Performance                                   │
│ ├─ Avg Cached Load: 0.7s                     │
│ ├─ Avg First Load: 18.5s                     │
│ └─ Time Saved: ~15.2 hours                   │
│                                               │
│ WCF Calls Saved: 3,946                       │
│ ├─ Estimated API cost saved: ~$157.84       │
│ └─ Estimated processing time saved: 21.8hrs  │
└─────────────────────────────────────────────┘
```

**Why This Matters**:
- Demonstrates cache value (time/cost savings)
- Identifies optimization opportunities
- Tracks system health

**Data Source**: `Schema__Cache__Stats` from `Proxy__Cache__Service`

---

#### **3.2.2 Per-Page Performance Visualization**

**Purpose**: Show performance trends over time for specific pages.

**Visual Design Concept**:
```
┌─────────────────────────────────────────────┐
│ example.com/about - Performance History      │
├─────────────────────────────────────────────┤
│ Load Time (seconds)                          │
│ 25s ┤                                        │
│ 20s ┤ ●                                      │
│ 15s ┤                                        │
│ 10s ┤                                        │
│  5s ┤                                        │
│  0s ┼───────●───●───●───●───●──→ Time       │
│       1st  2nd 3rd 4th 5th 6th              │
│                                               │
│ First load: 22.3s (LLM processing)           │
│ Subsequent loads: ~0.6s (cached)             │
│                                               │
│ Cache Status: ACTIVE ✓                       │
│ Last refresh: 2 hours ago                    │
└─────────────────────────────────────────────┘
```

**Why This Matters**:
- Visualizes cache effectiveness
- Identifies pages that need optimization
- Shows value of caching strategy

---

### 3.3 Explainability Features - "Why Was This Filtered?"

This is the **most critical** feature for user trust and system transparency.

#### **3.3.1 Content Classification Display**

**Purpose**: Show how each text segment was rated by the LLM.

**Current System Behavior** (from code):
- Text is extracted from HTML
- Sent to LLM for classification
- Rated for positivity/negativity
- Filtered based on threshold (e.g., < 0.5 removed)

**Visual Design Concept**:
```
┌──────────────────────────────────────────────────────┐
│ Content Analysis for: example.com/news/article-123   │
├──────────────────────────────────────────────────────┤
│ Filtering Applied: Minimum rating 0.5                │
│                                                       │
│ Paragraph 1: [Rating: 0.8] ✓ VISIBLE                │
│ "This breakthrough in renewable energy..."           │
│ Topics: [technology] [positive news] [science]       │
│                                                       │
│ Paragraph 2: [Rating: 0.3] ✗ HIDDEN                 │
│ "Controversy erupts over..."                         │
│ Topics: [conflict] [negative sentiment] [politics]   │
│ └─ Hidden: Rating below 0.5 threshold                │
│                                                       │
│ Paragraph 3: [Rating: 0.6] ✓ VISIBLE                │
│ "Experts agree that the future looks..."            │
│ Topics: [analysis] [neutral-positive] [opinion]      │
│                                                       │
│ Summary:                                              │
│ └─ 2 of 3 paragraphs shown (66%)                     │
└──────────────────────────────────────────────────────┘
```

**Why This Matters**:
- **Transparency**: User sees exactly what happened
- **Trust**: Can verify system isn't arbitrary
- **Feedback**: Can identify misclassifications
- **Education**: Understands how filtering works

**Data Requirements**:
- Text content (or hash reference)
- LLM rating score (0.0 - 1.0)
- Classification topics/tags
- Visibility status (shown/hidden)
- Threshold value used

---

#### **3.3.2 Visual Rating Distribution**

**Purpose**: Show the overall "shape" of content ratings on a page.

**Visual Design Concept**:
```
┌─────────────────────────────────────────────┐
│ Rating Distribution                          │
├─────────────────────────────────────────────┤
│ 1.0 ┤     ▄▄                                │
│ 0.8 ┤   ▄████▄                              │
│ 0.6 ┤ ▄███████▄                             │
│ 0.4 ┤ ████████▄                             │
│ 0.2 ┤ ██████▄                               │
│ 0.0 ┼────────────→                          │
│                                               │
│ Threshold: 0.5 [━━━━━━━━━━━]                │
│                                               │
│ Content above threshold: 73%                 │
│ Content below threshold: 27% (filtered out)  │
└─────────────────────────────────────────────┘
```

**Why This Matters**:
- Quick visual understanding of page sentiment
- Shows filtering impact at a glance
- Identifies pages that are mostly positive/negative

---

#### **3.3.3 Hash-Based Content Tracking**

**Current Implementation Note**: The video showed "Hash mode" displaying hash values and ratings.

**Purpose**: Link text hashes to their classifications for debugging and verification.

**Visual Design Concept**:
```
┌──────────────────────────────────────────────────────┐
│ Text Hash Analysis                                    │
├──────────────────────────────────────────────────────┘
│ Hash: a1b2c3d4...                                    │
│ Text: "This breakthrough in renewable energy..."    │
│ Rating: 0.8                                          │
│ Topics: [technology, positive, science]              │
│ Status: VISIBLE ✓                                    │
│ First seen: 2025-10-13                               │
│ Occurrences: 3 pages                                 │
│                                                       │
│ Also appears on:                                     │
│ ├─ example.com/news/article-456                     │
│ └─ example.com/blog/post-789                        │
└──────────────────────────────────────────────────────┘
```

**Why This Matters**:
- **Consistency**: Same text should have same rating
- **Efficiency**: Reuse ratings across pages
- **Debugging**: Track rating decisions
- **Quality**: Identify rating drift or errors

---

### 3.4 Debug/Development Tools

#### **3.4.1 Raw Cache Data Browser**

**Purpose**: Full technical visibility for developers.

**Features**:
- Browse cache structure as file tree
- View raw JSON for any cache entry
- Download any transformation
- See exact storage paths
- Inspect metadata fields

**Access Control**: 
- Developer mode toggle (cookie/query param)
- Separate from user-facing explainability

**Why This Matters**:
- Essential for debugging cache issues
- Verify data integrity
- Test new transformations
- Understand storage patterns

---

#### **3.4.2 Live Request Inspector**

**Purpose**: Real-time view of proxy requests and cache operations.

**Visual Design Concept**:
```
┌──────────────────────────────────────────────────────┐
│ Live Request Monitor                       [Pause]    │
├──────────────────────────────────────────────────────┤
│ 14:32:15 ➡️  GET example.com/about                   │
│          └─ Cache: HIT (0.6s)                        │
│                                                       │
│ 14:32:18 ➡️  GET example.com/products                │
│          ├─ Cache: MISS                              │
│          ├─ WCF: Extracting... (2.3s)                │
│          ├─ LLM: Classifying... (18.7s)              │
│          └─ Total: 22.1s                             │
│                                                       │
│ 14:32:42 ➡️  GET example.com/contact                 │
│          └─ Cache: HIT (0.5s)                        │
└──────────────────────────────────────────────────────┘
```

**Why This Matters**:
- See system behavior in real-time
- Identify slow requests immediately
- Verify cache hit/miss patterns
- Debug classification pipeline

---

## 4. Technical Implementation Approach

### 4.1 Architecture Principles

**1. API-First Design**
- All features backed by REST endpoints
- Admin UI is thin client
- Enable programmatic access
- Future-proof for other clients

**2. Progressive Enhancement**
- Basic functionality works without JavaScript
- Enhanced UX with client-side interactivity
- Graceful degradation

**3. Dual-Mode Architecture**
- Developer mode: Full data exposure
- User mode: Simplified explainability
- Toggle via query param or cookie

**4. Performance Considerations**
- Lazy loading for large datasets
- Pagination for page lists
- Caching of metadata
- Efficient JSON structures

---

### 4.2 API Endpoints Needed

**Extend existing `/mitm-proxy/admin-ui.json` or create new endpoints:**

#### **Site & Page Navigation**
```
GET /mitm-proxy/api/sites
→ List all cached sites with metadata

GET /mitm-proxy/api/sites/{domain}/pages
→ List all pages for a site

GET /mitm-proxy/api/sites/{domain}/pages/{path}
→ Get page details, transformations, ratings
```

#### **Statistics & Metrics**
```
GET /mitm-proxy/api/stats/global
→ Cache-wide statistics

GET /mitm-proxy/api/stats/site/{domain}
→ Per-site statistics

GET /mitm-proxy/api/stats/page/{cache_id}
→ Per-page performance history
```

#### **Content & Explainability**
```
GET /mitm-proxy/api/page/{cache_id}/classifications
→ LLM ratings for page content

GET /mitm-proxy/api/page/{cache_id}/hashes
→ Text hashes with ratings

GET /mitm-proxy/api/page/{cache_id}/analysis
→ Rating distribution, filtering summary
```

#### **Debug Tools**
```
GET /mitm-proxy/api/cache/browse?path={cache_path}
→ Browse cache structure

GET /mitm-proxy/api/cache/entry/{cache_id}
→ Raw cache entry JSON

GET /mitm-proxy/api/live/requests
→ WebSocket or SSE for live monitoring
```

---

### 4.3 Integration with Existing System

**Leverage existing components:**

1. **`Proxy__Cache__Service`**: Already has methods for cache access
   - `get_page_entry__via__target_url()`
   - `get_cached_transformation()`
   - `get_cache_stats()`

2. **`Proxy__Admin__Service`**: Extend this for new endpoints
   - Add new route handlers
   - Keep static file serving
   - Add API key validation

3. **Cache Client**: `Service__Fast_API__Client`
   - Already configured
   - Use for backend data retrieval

**Data Flow**:
```
Admin UI (JavaScript)
    ↓ HTTP Request
FastAPI Routes (Proxy__Admin__Service)
    ↓ Service Call
Proxy__Cache__Service
    ↓ Cache Client
Cache Backend (Memory/S3/Disk)
    ↓ JSON Response
Admin UI (Render)
```

---

### 4.4 Frontend Technology Choices

**Recommendation**: Pure HTML + JavaScript (as specified)

**Why**:
- No build step required
- Easy to debug and modify
- Fast initial load
- Works in iframe/admin panel context

**Suggested Libraries** (loaded via CDN):
- **Chart.js** or **D3.js**: For visualizations
- **Marked.js**: If markdown rendering needed
- **DOMPurify**: For safe HTML rendering
- **Native Fetch API**: For HTTP requests

**Structure**:
```
/mitm-proxy/
├── v0/
│   └── v0.1.1/
│       ├── index.html         (main dashboard)
│       ├── sites.html         (site list)
│       ├── page-detail.html   (page analysis)
│       ├── explain.html       (user explainability)
│       ├── debug.html         (developer tools)
│       ├── app.js             (main logic)
│       └── styles.css         (styling)
```

---

## 5. User Experience Flows

### 5.1 Developer Debugging Flow

**Scenario**: Developer notices slow page loads and wants to investigate.

**Flow**:
1. Open `/mitm-proxy/` admin panel
2. Navigate to "Sites" tab
3. See `example.com` has low cache hit rate (45%)
4. Click to expand, see page list
5. Notice `/products` has 22s avg load time
6. Click "Details" on that page
7. See it's marked as "Slow first load"
8. View transformations - notice large HTML size
9. Check "Live Monitor" - see LLM taking 18s
10. **Insight**: Need to optimize LLM payload size

**Success**: Developer identifies bottleneck and can take action.

---

### 5.2 User Trust-Building Flow

**Scenario**: User browsing filtered news site wonders why articles are missing.

**Flow**:
1. Page loads with some content hidden
2. User notices filter indicator (injected banner)
3. Clicks "Why was content filtered?"
4. Sees classification overlay:
   - Green highlights: Visible content (rating > 0.5)
   - Red highlights: Hidden content (rating < 0.5)
5. Hovers over hidden section
6. Tooltip shows: "Rated 0.3 - Topics: [conflict, negative sentiment]"
7. User understands filtering logic
8. Can adjust threshold slider to see more/less

**Success**: User understands system behavior and feels in control.

---

### 5.3 Performance Validation Flow

**Scenario**: System admin wants to verify cache is working.

**Flow**:
1. Open `/mitm-proxy/api/stats/global`
2. See overall hit rate: 87%
3. Check "Time Saved" metric: 15.2 hours
4. Browse to specific high-traffic page
5. View performance history chart
6. Confirm first load (22s) → cached loads (0.6s)
7. Export stats for reporting

**Success**: Admin confirms system is delivering value.

---

## 6. Implementation Phases

### Phase 2.1: Foundation (Week 1)
**Goal**: Basic navigation and statistics

- [ ] API endpoints for sites/pages listing
- [ ] Simple site inventory view
- [ ] Page list view with basic metrics
- [ ] Global cache statistics dashboard
- [ ] Integration with existing admin panel

**Deliverable**: Can browse cached content and see hit rates.

---

### Phase 2.2: Page Details (Week 2)
**Goal**: Deep dive into individual pages

- [ ] Page detail view with all metadata
- [ ] Transformation viewer (HTML, text, ratings)
- [ ] Download functionality for transformations
- [ ] Per-page performance metrics
- [ ] Raw cache entry JSON view

**Deliverable**: Full visibility into any cached page.

---

### Phase 2.3: Explainability (Week 3)
**Goal**: User-facing filtering transparency

- [ ] Content classification display
- [ ] Rating distribution visualization
- [ ] Topic/tag display per segment
- [ ] Threshold control interface
- [ ] "Why was this hidden?" tooltips

**Deliverable**: Users understand filtering decisions.

---

### Phase 2.4: Advanced Features (Week 4)
**Goal**: Developer tools and polish

- [ ] Live request monitor (WebSocket/SSE)
- [ ] Cache data browser (file tree)
- [ ] Hash-based content tracking
- [ ] Performance trend charts
- [ ] Export/download features
- [ ] Responsive design polish

**Deliverable**: Complete developer and user toolset.

---

## 7. Success Metrics

### Developer Metrics
- **Time to debug**: < 5 minutes to identify cache issues
- **Visibility**: 100% of cache operations visible in UI
- **Data access**: All transformations downloadable
- **Performance insight**: Clear identification of bottlenecks

### User Metrics
- **Transparency**: Every filtering decision explainable
- **Trust**: User can verify system behavior
- **Control**: Can adjust filtering thresholds
- **Understanding**: Knows why content shown/hidden

### System Metrics
- **Cache effectiveness**: Hit rate > 80%
- **Performance**: Cached loads < 1s
- **Cost savings**: Measurable reduction in LLM calls
- **Reliability**: No unexplained cache misses

---

## 8. Design Principles

### 8.1 Simplicity Over Complexity
- Start with basic views, add complexity only when needed
- Progressive disclosure of information
- Don't overwhelm with too much data at once

### 8.2 Transparency as Default
- Default to showing more information
- Let users hide what they don't need
- No "magic" - always explain what's happening

### 8.3 Developer-First, User-Friendly
- Build for developers first (they're the current users)
- Design user-facing features with future in mind
- Keep technical details accessible but not intrusive

### 8.4 Performance-Aware
- Don't sacrifice speed for features
- Lazy load large datasets
- Cache metadata aggressively
- Optimize for common cases (viewing recent pages)

---

## 9. Open Questions & Future Considerations

### 9.1 Multi-LLM Support
Current system uses single LLM for classification. Future:
- Show classifications from multiple models
- Compare rating differences
- Allow model selection per page

### 9.2 Historical Tracking
Currently focuses on current state. Consider:
- Rating changes over time
- Page content evolution
- Cache invalidation strategies

### 9.3 User Feedback Loop
- Allow users to rate the classifications
- "Was this filtering correct?"
- Feed back into model training

### 9.4 Collaboration Features
- Share filtered views
- Annotate pages
- Export filtered content

---

## 10. Appendix: Key Code References

### Cache Service Integration
- **Main service**: `Proxy__Cache__Service` in `service/cache/`
- **Cache config**: `Schema__Cache__Config`
- **Statistics**: `Schema__Cache__Stats`
- **Page entry**: `Schema__Cache__Page__Entry`

### Admin Panel Foundation
- **Admin service**: `Proxy__Admin__Service` in `service/admin/`
- **Current endpoint**: `/mitm-proxy/admin-ui.json`
- **Static files**: `mgraph_ai_service_mitmproxy__admin_ui` package

### WCF Integration
- **WCF service**: `Proxy__WCF__Service` in `service/wcf/`
- **Command types**: `Enum__WCF__Command_Type`
- **Transformations**: `Enum__Cache__Transformation_Type`

### Cookie Management
- **Cookie service**: `Proxy__Cookie__Service`
- **Cookie parsing**: `parse_cookies_from_header()`
- **Debug params**: `convert_to_debug_params()`

---

## Conclusion

This phase transforms the content filtering platform from a working MVP into a transparent, debuggable, and user-friendly system. By providing comprehensive navigation, detailed statistics, and clear explainability, we enable both developers to optimize the system and users to trust its decisions.

The phased implementation approach ensures steady progress while maintaining system stability. Each phase builds on the previous, creating a cohesive experience that serves both technical and non-technical users.

**Key Success Factor**: Transparency. Every decision the system makes should be visible, explainable, and verifiable.