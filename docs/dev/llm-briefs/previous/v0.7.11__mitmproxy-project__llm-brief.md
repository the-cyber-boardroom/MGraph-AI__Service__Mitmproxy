# LLM Brief: MGraph-AI Service - mitmproxy

## Project Overview

**Repository**: `the-cyber-boardroom/MGraph-AI__Service__mitmproxy`  
**Version**: v0.7.11  
**Last Updated**: 2025-10-10

This is a sophisticated HTTP/HTTPS proxy service built on top of mitmproxy that provides intelligent request/response interception, modification, and debugging capabilities. The service acts as a middleware layer that can:

1. Intercept HTTP/HTTPS traffic
2. Apply real-time modifications to requests and responses
3. Integrate with external services (Web Content Filtering)
4. Provide debugging and inspection capabilities
5. Offer a web-based admin interface for monitoring and control

## Core Architecture

### Three-Layer Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  1. MITMPROXY INTERCEPTOR (Python addon)                    │
│     - Runs inside mitmproxy process                         │
│     - Captures HTTP/HTTPS traffic                           │
│     - Sends data to FastAPI service                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. FASTAPI SERVICE (This codebase)                         │
│     - Receives request/response data                        │
│     - Processes debug commands from cookies                 │
│     - Integrates with external services (WCF)               │
│     - Returns modifications to apply                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. EXTERNAL INTEGRATIONS                                   │
│     - Web Content Filtering (WCF) service                   │
│     - HTML/content transformation services                  │
└─────────────────────────────────────────────────────────────┘
```

### Service Flow

**Request Flow:**
```
Client → mitmproxy → FastAPI /proxy/process-request → [modifications] → Upstream Server
```

**Response Flow:**
```
Upstream Server → mitmproxy → FastAPI /proxy/process-response → [modifications] → Client
```

## Key Design Patterns

### 1. Cookie-Based Control
The service uses **cookies** (prefixed with `mitm-*`) to control proxy behavior:
- `mitm-show`: Display/transform content (e.g., `url-to-html`, `url-to-text`)
- `mitm-inject`: Inject debug panels/banners
- `mitm-replace`: Text replacement
- `mitm-debug`: Enable debug mode
- `mitm-cache`: Enable response caching
- `mitm-rating`: Set content filtering thresholds
- `mitm-model`: Override AI model selection

**Why cookies?** This allows browser-based control without modifying URLs, making it transparent and persistent across navigation.

### 2. Type-Safe Schema System
Uses `osbot_utils.type_safe.Type_Safe` extensively for:
- Safe string types with validation (Safe_Str__HTTP__Host, Safe_Str__HTTP__Method)
- Safe integer types (Safe_UInt__HTTP__Status, Safe_UInt__Port)
- Domain-specific validations (Docker names, URLs, versions)
- Automatic sanitization of untrusted input

### 3. Service-Oriented Architecture
Clean separation of concerns with dedicated services:
- **Stats Service**: Track requests, responses, bytes processed
- **Cookie Service**: Parse and interpret cookie-based controls
- **Debug Service**: Process debug commands and inject content
- **WCF Service**: Integration with Web Content Filtering API
- **CORS Service**: Handle cross-origin requests
- **HTML Service**: Manipulate HTML content
- **Admin Service**: Serve web-based dashboard

### 4. Modification Pattern
All changes to requests/responses go through `Schema__Proxy__Modifications`:
```python
modifications = Schema__Proxy__Modifications()
modifications.headers_to_add = {"x-custom": "value"}
modifications.modified_body = "<html>...</html>"
modifications.override_response = True
```

This creates a clear contract between the FastAPI service and mitmproxy interceptor.

## Directory Structure

```
mgraph_ai_service_mitmproxy/
├── config.py                      # Service configuration
├── fast_api/                      # FastAPI application
│   ├── Service__Fast_API.py       # Main FastAPI service class
│   ├── lambda_handler.py          # AWS Lambda entry point
│   └── routes/
│       ├── Routes__Info.py        # Health/status endpoints
│       └── Routes__Proxy.py       # Main proxy endpoints
├── schemas/                       # Type-safe data structures
│   ├── proxy/                     # Request/response schemas
│   ├── debug/                     # Debug command schemas
│   ├── wcf/                       # WCF integration schemas
│   └── docker/                    # Docker-related schemas
├── service/                       # Business logic
│   ├── proxy/                     # Core proxy services
│   │   ├── Proxy__Service.py          # Main orchestrator
│   │   ├── Proxy__Request__Service.py # Request processing
│   │   ├── Proxy__Response__Service.py# Response processing
│   │   ├── Proxy__Cookie__Service.py  # Cookie parsing
│   │   ├── Proxy__Debug__Service.py   # Debug command processing
│   │   ├── Proxy__Stats__Service.py   # Statistics tracking
│   │   ├── Proxy__CORS__Service.py    # CORS handling
│   │   ├── Proxy__HTML__Service.py    # HTML manipulation
│   │   └── Proxy__Headers__Service.py # Header management
│   ├── admin/                     # Admin UI
│   │   └── Proxy__Admin__Service.py   # Dashboard backend
│   ├── wcf/                       # WCF integration
│   │   └── Proxy__WCF__Service.py     # WCF API client
│   ├── mitmproxy/                 # Deployment helpers
│   └── info/                      # Service info endpoints
└── utils/                         # Utilities
```

## Critical Service Components

### Proxy__Service (Main Orchestrator)
**Location**: `service/proxy/Proxy__Service.py`

The top-level service that:
- Delegates to specialized sub-services
- Logs requests/responses with emojis for readability
- Coordinates stats tracking
- Provides unified interface for routes

**Key Methods**:
- `process_request()`: Handle incoming requests
- `process_response()`: Handle outgoing responses
- `get_stats()`: Retrieve statistics
- `reset_stats()`: Clear statistics

### Proxy__Cookie__Service (Cookie Parser)
**Location**: `service/proxy/Proxy__Cookie__Service.py`

Sophisticated cookie parser that handles:
- Malformed cookies (BBC-style comma separators)
- JSON values in cookies
- Escape sequences
- Flag cookies (without values)

**Special Algorithm**: Character-by-character parsing with depth tracking for nested braces/quotes.

### Proxy__Debug__Service (Debug Commands)
**Location**: `service/proxy/Proxy__Debug__Service.py`

Processes debug commands from cookies:
- **show**: Display internal data or call WCF
- **inject**: Inject debug panels/banners into HTML
- **replace**: Text replacement in responses
- **debug mode**: Enable debug visualizations

**Critical**: This service can **override entire responses** when processing WCF commands.

### Proxy__WCF__Service (External Integration)
**Location**: `service/wcf/Proxy__WCF__Service.py`

Integrates with Web Content Filtering service at:
`https://dev.web-content-filtering.mgraph.ai`

Supports commands like:
- `url-to-html`: Convert URL to clean HTML
- `url-to-text`: Extract text content
- `url-to-ratings`: Get content ratings
- `url-to-html-min-rating`: Filter by rating threshold

**Authentication**: Uses environment variables for API keys.

### Proxy__Stats__Service (Metrics)
**Location**: `service/proxy/Proxy__Stats__Service.py`

Tracks:
- Total requests/responses
- Bytes processed
- Content modifications
- (Previously tracked hosts/paths, now removed for performance)

### Proxy__Admin__Service (Dashboard)
**Location**: `service/admin/Proxy__Admin__Service.py`

Serves static admin UI at `/mitm-proxy/*` with:
- Real-time statistics display
- Cookie configuration interface
- Request/response monitoring
- JSON API at `/mitm-proxy/admin-ui.json`

## Important Schemas

### Schema__Proxy__Request_Data
**Location**: `schemas/proxy/Schema__Proxy__Request_Data.py`

Incoming request from mitmproxy interceptor:
```python
{
    method: Safe_Str__HTTP__Method    # GET, POST, etc.
    host: Safe_Str__HTTP__Host        # Target host
    path: str                         # Request path
    debug_params: Dict[str, str]      # Populated from cookies
    headers: Dict[str, str]           # Includes Cookie header
    stats: Dict[str, Any]             # Request statistics
    version: Safe_Str__Version        # Interceptor version
}
```

### Schema__Proxy__Response_Data
**Location**: `schemas/proxy/Schema__Proxy__Response_Data.py`

Incoming response from mitmproxy interceptor:
```python
{
    request: Dict[str, Any]           # Original request info
    debug_params: Dict[str, str]      # Populated from cookies
    response: {
        status_code: int
        content_type: str
        body: str
        headers: Dict[str, str]
    }
    stats: Dict[str, Any]
    version: Safe_Str__Version
}
```

### Schema__Proxy__Modifications
**Location**: `schemas/proxy/Schema__Proxy__Modifications.py`

Response to mitmproxy interceptor:
```python
{
    headers_to_add: Dict[str, str]        # Add these headers
    headers_to_remove: List[str]          # Remove these headers
    cached_response: Dict                 # Skip upstream, return this
    modified_body: Optional[str]          # Replace body content
    override_response: bool               # Complete override
    override_status: Optional[int]        # Override status code
    override_content_type: Optional[str]  # Override content type
    block_request: bool                   # Block the request
}
```

## API Endpoints

### Proxy Endpoints (`/proxy/*`)
- `POST /proxy/process-request`: Process incoming request
- `POST /proxy/process-response`: Process outgoing response
- `GET /proxy/get-proxy-stats`: Retrieve statistics
- `POST /proxy/reset-proxy-stats`: Clear statistics

### Info Endpoints (`/info/*`)
- `GET /info/health`: Health check (returns `{"status": "ok"}`)
- `GET /info/status`: Service status and environment
- `GET /info/versions`: Library versions
- `GET /info/server`: Server information

### Admin Endpoints (`/mitm-proxy/*`)
- `GET /mitm-proxy/`: Redirect to latest admin UI
- `GET /mitm-proxy/v0/{version}/`: Static admin UI files
- `GET /mitm-proxy/admin-ui.json`: JSON API for dashboard

## Environment Variables

```bash
# WCF Service Authentication
WCF_SERVICE__AUTH__API_KEY__NAME="x-api-key"
WCF_SERVICE__AUTH__API_KEY__VALUE="your-secret-key"

# AWS (for Lambda deployment)
AWS_REGION="us-east-1"

# EC2 Testing (for mitmproxy deployment)
EC2_TESTS__SECURITY_GROUP_ID="sg-xxxxx"
EC2_TESTS__PATH_SSH_KEY_FILE_NAME="your-key.pem"
EC2_TESTS__PATH_SSH_KEY_USER="ubuntu"
```

## Important Implementation Details

### 1. Cookie Parsing Robustness
The `Proxy__Cookie__Service` handles real-world malformed cookies, including:
- cookies using commas instead of semicolons
- JSON values with braces and quotes
- Escape sequences in quoted strings
- Flag cookies without values

**Algorithm**: Character-by-character scan tracking brace/quote depth.

### 2. Debug Command Priority
When multiple debug commands are present:
1. **show commands** take absolute precedence (override everything)
2. **inject commands** modify HTML content
3. **replace commands** perform text substitution

### 3. WCF Integration Flow
```
1. Cookie contains: mitm-show=url-to-html
2. Debug service detects WCF command
3. WCF service constructs request URL
4. Makes HTTP request to WCF service
5. Receives transformed content (HTML/JSON/text)
6. Returns as override response to mitmproxy
7. Client receives transformed content
```

### 4. Admin UI Architecture
- **Static files**: Served from `mgraph_ai_service_mitmproxy__admin_ui` package
- **Versioning**: `/mitm-proxy/v0/v0.1.0/` allows multiple UI versions
- **JSON API**: Real-time data via `/mitm-proxy/admin-ui.json`
- **Security**: Path traversal protection with `.resolve()` checks

### 5. Stats Performance
Originally tracked `hosts_seen` and `paths_seen` as sets, but this caused memory issues. Now only tracks:
- Request/response counts
- Bytes processed
- Content modification count

### 6. HTTP/2 Compatibility
All header names are **lowercase** for HTTP/2 compatibility:
```python
headers["x-proxy-service"] = "mgraph-proxy"  # lowercase
headers["cache-control"] = "no-cache"        # lowercase
```

## Deployment Options

### 1. AWS Lambda (Serverless)
```python
from mgraph_ai_service_mitmproxy.utils.deploy.Deploy__Service import Deploy__Service

deployer = Deploy__Service()
deployer.deploy_lambda()
```

Dependencies loaded on-demand via `osbot-fast-api-serverless`.

### 2. Docker Container
```python
from mgraph_ai_service_mitmproxy.service.mitmproxy.Mitmproxy__Create__Docker_Container import Mitmproxy__Create__Docker_Container

container = Mitmproxy__Create__Docker_Container()
container.create_container(with_custom_script=True)
container.start()
```

Builds custom mitmproxy image with FastAPI interceptor.

### 3. EC2 Instance
```python
from mgraph_ai_service_mitmproxy.service.mitmproxy.Mitmproxy__Create__EC2_Instance import Mitmproxy__Create__EC2_Instance

ec2_manager = Mitmproxy__Create__EC2_Instance()
instance_id = ec2_manager.create_ec2_instance()
ec2_manager.ec2_install_mitmproxy(instance_id)
```

Automated EC2 deployment with systemd service.

## Common Refactoring Patterns

### When Working on Service Classes
1. **Always use Type_Safe base class**: Ensures type validation
2. **Keep methods focused**: Single responsibility per method
3. **Use descriptive parameter names**: With type hints
4. **Document with inline comments**: Type comments after parameters
5. **Return Type_Safe schemas**: Not raw dicts

### When Adding New Features
1. **Create schema first**: Define data structures in `schemas/`
2. **Add service logic**: Implement in appropriate `service/` directory
3. **Wire to route**: Connect in `fast_api/routes/`
4. **Add tests**: Follow existing test patterns
5. **Update version**: Increment in `version` file

### When Modifying Headers
- Use lowercase header names for HTTP/2 compatibility
- Add via `modifications.headers_to_add`, don't modify original
- Use `Proxy__Headers__Service` for standard headers

### When Processing Cookies
- Always use `Proxy__Cookie__Service.parse_cookies()`
- Extract from `headers` dict, not query string
- Merge with existing `debug_params`
- Validate with `Safe_Str__Cookie_Name` and `Safe_Str__Cookie_Value`

## Testing Strategy

### Unit Tests
- Test each service in isolation
- Mock external dependencies (WCF service)
- Test cookie parsing edge cases
- Validate type-safe schema constraints

### Integration Tests
- Test complete request/response flow
- Verify modifications applied correctly
- Test admin UI endpoints
- Validate WCF integration

### E2E Tests
- Deploy to test environment
- Send real HTTP traffic through proxy
- Verify transformations applied
- Test debug commands via cookies

## Known Limitations

1. **No persistent storage**: Stats reset on service restart
2. **Synchronous WCF calls**: Can add latency to responses
3. **Memory constraints**: Large response bodies held in memory
4. **Single-instance**: No distributed coordination
5. **No authentication**: Service endpoints not protected

## Future Enhancement Areas

1. **Redis integration**: For distributed stats and caching
2. **Async WCF calls**: Non-blocking external service calls
3. **Streaming responses**: For large content
4. **Authentication**: API key or OAuth protection
5. **Rate limiting**: Protect against abuse
6. **Metrics export**: Prometheus/CloudWatch integration
7. **Request replay**: Capture and replay traffic

## Quick Reference: File Purposes

| File | Purpose |
|------|---------|
| `Proxy__Service.py` | Main orchestrator, delegates to sub-services |
| `Proxy__Request__Service.py` | Process incoming requests, check caching |
| `Proxy__Response__Service.py` | Process responses, coordinate modifications |
| `Proxy__Cookie__Service.py` | Parse cookies, extract proxy controls |
| `Proxy__Debug__Service.py` | Process debug commands, inject content |
| `Proxy__WCF__Service.py` | Call Web Content Filtering API |
| `Proxy__Stats__Service.py` | Track metrics (requests/responses/bytes) |
| `Proxy__CORS__Service.py` | Add CORS headers, handle preflight |
| `Proxy__HTML__Service.py` | Manipulate HTML content |
| `Proxy__JSON__Service.py` | Manipulate JSON content |
| `Proxy__Headers__Service.py` | Generate standard headers |
| `Proxy__Admin__Service.py` | Serve admin dashboard |
| `Routes__Proxy.py` | FastAPI endpoints for proxy operations |
| `Routes__Info.py` | Health/status endpoints |

## Tips for Working with This Codebase

1. **Start with schemas**: Understand data structures first
2. **Follow the flow**: Request → Service → Modifications → Response
3. **Use type hints**: Leverage Type_Safe for validation
4. **Read service interfaces**: Public methods define capabilities
5. **Check admin UI**: Visual debugging tool at `/mitm-proxy/`
6. **Test with cookies**: Use browser DevTools to set `mitm-*` cookies
7. **Watch logs**: Service prints emoji-rich logs for readability
8. **Use WCF carefully**: External service calls add latency

## Version History Context

- **v0.7.11** (current): Refactored services architecture, cookie-based control
- Earlier versions: Query-string based debug params, monolithic route handler

The refactoring from query-string to cookie-based control was a major architectural change that improved:
- URL cleanliness
- Cross-page persistence
- Browser-based debugging
- Separation of concerns

---

**When to Use This Brief**: Provide this document to an LLM when working on specific parts of the codebase that exceed context limits. This brief provides the necessary background to understand design decisions, architectural patterns, and integration points without needing the full source code.
