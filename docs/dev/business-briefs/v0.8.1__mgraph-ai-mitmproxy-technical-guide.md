# MGraph AI Service Mitmproxy - Technical Architecture Guide

**Version:** v0.8.1  
**Date:** November 2024  
**Audience:** Technical Architects, Technical Business Owners

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Architecture Overview](#2-architecture-overview)
3. [Request/Response Pipeline](#3-requestresponse-pipeline)
4. [HTML Transformation System](#4-html-transformation-system)
5. [Service Integrations](#5-service-integrations)
6. [Transformation Modes & Engines](#6-transformation-modes--engines)
7. [Cache Architecture](#7-cache-architecture)
8. [Cookie-Based Control](#8-cookie-based-control)
9. [Configuration & Deployment](#9-configuration--deployment)
10. [Operational Monitoring](#10-operational-monitoring)

---

## 1. Executive Summary

### 1.1 Purpose

The MGraph AI Service Mitmproxy is a FastAPI-based proxy service that intercepts HTTP traffic and applies intelligent HTML transformations. It enables sentiment-aware content filtering and privacy-preserving text masking through a multi-stage pipeline that integrates three specialized microservices.

### 1.2 Key Capabilities

**Active Features:**
- **Cookie-Based Control**: Control transformation behavior via HTTP cookies (no URL parameter pollution)
- **3-Step HTML Transformation Pipeline**: 
  - HTML → Hash Mapping (HTML Service)
  - Semantic Classification & Transformation (Semantic Text Service)
  - Hash Mapping → Transformed HTML (HTML Service)
- **Multi-Mode Transformations**:
  - Visual: `xxx`, `hashes`, `abcde-by-size`
  - Engines: `AWS Comprehend`, `Text Hash`, `Random`
- **Intelligent Caching**: Page-level and transformation-level caching
- **Admin Dashboard**: Real-time monitoring and control interface

### 1.3 System Dependencies

```
┌─────────────────────────────────────────────────────────────┐
│                    External Services                        │
├─────────────────────────────────────────────────────────────┤
│  • HTML Service          (html.dev.mgraph.ai)              │
│  • Semantic Text Service (semantic-text.dev.mgraph.ai)     │
│  • Cache Service         (cache.dev.mgraph.ai)             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Architecture Overview

### 2.1 High-Level System Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                         Client Browser                               │
│                    (Sets mitm-mode cookie)                           │
└────────────────────┬─────────────────────────────────────────────────┘
                     │ HTTP Request
                     ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    Mitmproxy Interceptor                             │
│                  (Python addon running in mitmproxy)                 │
└────────────────────┬─────────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────────┐
│               MGraph AI Service (FastAPI)                            │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Request Processing                                            │ │
│  │  • Cookie Parser                                               │ │
│  │  • Admin Page Router                                           │ │
│  │  • Stats Tracker                                               │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  Response Processing                                           │ │
│  │  • Transformation Decision Engine                              │ │
│  │  • HTML Transformation Service ──────────────────┐            │ │
│  │  • Cache Integration                             │            │ │
│  │  • Header Management                             │            │ │
│  └──────────────────────────────────────────────────┼────────────┘ │
└──────────────────────────────────────────────────────┼──────────────┘
                                                       │
                     ┌─────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────────┐
│                   3-Step Transformation Pipeline                     │
│                                                                      │
│  ┌──────────────┐      ┌─────────────────┐      ┌──────────────┐  │
│  │   Step 1     │─────▶│     Step 2      │─────▶│   Step 3     │  │
│  │              │      │                 │      │              │  │
│  │ HTML Service │      │ Semantic Text   │      │ HTML Service │  │
│  │ (to hashes)  │      │ Service         │      │ (from hashes)│  │
│  │              │      │ (transform)     │      │              │  │
│  └──────────────┘      └─────────────────┘      └──────────────┘  │
│         │                       │                       │          │
│         └───────────────────────┴───────────────────────┘          │
│                                 │                                  │
│                        ┌────────▼─────────┐                        │
│                        │  Cache Service   │                        │
│                        │  (stores results)│                        │
│                        └──────────────────┘                        │
└──────────────────────────────────────────────────────────────────────┘
```

### 2.2 Component Interaction Flow

```
┌──────────────┐
│   Browser    │
└──────┬───────┘
       │ 1. Request with mitm-mode=xxx-negative cookie
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│  Proxy Request Handler                                   │
│  • Parse cookies (Proxy__Cookie__Service)                │
│  • Route admin requests (/mitm-proxy/*)                  │
│  • Track statistics                                      │
└──────┬───────────────────────────────────────────────────┘
       │ 2. Forward to upstream server
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│  Upstream Server (e.g., https://example.com)             │
└──────┬───────────────────────────────────────────────────┘
       │ 3. HTML Response
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│  Proxy Response Handler                                  │
│  • Extract mitm-mode cookie value                        │
│  • Check cache for existing transformation               │
│  • If cache miss, invoke transformation pipeline         │
│  • Store result in cache                                 │
│  • Return transformed HTML                               │
└──────┬───────────────────────────────────────────────────┘
       │ 4. Transformed HTML
       │
       ▼
┌──────────────┐
│   Browser    │
└──────────────┘
```

---

## 3. Request/Response Pipeline

### 3.1 Request Processing Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Request Processing                       │
└─────────────────────────────────────────────────────────────┘

HTTP Request
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. Parse Request Headers                │
│    • Extract Cookie header              │
│    • Parse mitm-mode value              │
│    • Parse other control cookies        │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 2. Route Decision                       │
│    ┌───────────────────────────────┐   │
│    │ Is Admin Path?                │   │
│    │ (/mitm-proxy/*)               │   │
│    └───┬───────────────────┬───────┘   │
│        │ Yes               │ No         │
│        ▼                   ▼            │
│    [Admin Handler]   [Proxy Forward]   │
└────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 3. Add Tracking Headers                 │
│    • x-request-id                       │
│    • x-processed-at                     │
│    • x-proxy-cookies (if present)       │
└─────────┬───────────────────────────────┘
          │
          ▼
    Forward to Upstream
```

### 3.2 Response Processing Flow

```
┌─────────────────────────────────────────────────────────────┐
│                   Response Processing                       │
└─────────────────────────────────────────────────────────────┘

Upstream HTML Response
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. Extract Control Information          │
│    • mitm-mode cookie from request      │
│    • Content-Type (must be text/html)   │
│    • Original URL for cache key         │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 2. Transformation Decision              │
│    ┌───────────────────────────────┐   │
│    │ mitm-mode = "off"?            │   │
│    └───┬───────────────────┬───────┘   │
│        │ Yes               │ No         │
│        ▼                   ▼            │
│    [Pass Through]   [Check Cache]      │
└────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 3. Cache Lookup                         │
│    Key: sites/{domain}/pages/{path}    │
│    Data Key: transformations/{mode}    │
│    ┌───────────────────────────────┐   │
│    │ Cache Hit?                    │   │
│    └───┬───────────────────┬───────┘   │
│        │ Yes               │ No         │
│        ▼                   ▼            │
│    [Return Cached]   [Transform]       │
└────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 4. Apply Transformation                 │
│    (See Section 4 for details)          │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 5. Store in Cache                       │
│    • Original HTML                      │
│    • Transformed result                 │
│    • Metadata (time, mode, stats)       │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 6. Add Response Headers                 │
│    • x-proxy-transformation             │
│    • x-proxy-cache (hit/miss)           │
│    • x-html-service-time                │
│    • content-type                       │
└─────────┬───────────────────────────────┘
          │
          ▼
    Return to Browser
```

---

## 4. HTML Transformation System

### 4.1 Three-Step Pipeline Overview

The transformation system follows a three-step pipeline that preserves HTML structure while transforming text content based on semantic classification:

```
┌───────────────────────────────────────────────────────────────────────┐
│                     3-Step Transformation Pipeline                    │
└───────────────────────────────────────────────────────────────────────┘

Original HTML
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 1: HTML → Hash Mapping                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  HTML Service: POST /html/to/dict/hashes                      │  │
│  │                                                                │  │
│  │  Input:  <p>This is positive!</p>                             │  │
│  │                                                                │  │
│  │  Output: {                                                     │  │
│  │    html_dict: {                                                │  │
│  │      tag: "p",                                                 │  │
│  │      hash: "abc123"                                            │  │
│  │    },                                                          │  │
│  │    hash_mapping: {                                             │  │
│  │      "abc123": "This is positive!"                             │  │
│  │    }                                                           │  │
│  │  }                                                             │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 2: Semantic Classification & Transformation                   │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Semantic Text Service: POST /text-transformation/transform   │  │
│  │                                                                │  │
│  │  Input: {                                                      │  │
│  │    hash_mapping: { "abc123": "This is positive!" },           │  │
│  │    engine_mode: "AWS_COMPREHEND",                             │  │
│  │    criterion_filters: [                                        │  │
│  │      { criterion: "positive", filter_mode: "above",           │  │
│  │        threshold: 0.7 }                                        │  │
│  │    ],                                                          │  │
│  │    transformation_mode: "XXX"                                  │  │
│  │  }                                                             │  │
│  │                                                                │  │
│  │  Process:                                                      │  │
│  │  1. Classify "This is positive!" → 0.92 positive              │  │
│  │  2. 0.92 > 0.7 ✓ → Apply transformation                       │  │
│  │  3. Transform to: "xxxx xx xxxxxxxx!"                         │  │
│  │                                                                │  │
│  │  Output: {                                                     │  │
│  │    transformed_mapping: {                                      │  │
│  │      "abc123": "xxxx xx xxxxxxxx!"                            │  │
│  │    },                                                          │  │
│  │    transformed_hashes: 1,                                      │  │
│  │    total_hashes: 1                                             │  │
│  │  }                                                             │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  STEP 3: Hash Mapping → Transformed HTML                           │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  HTML Service: POST /hashes/to/html                           │  │
│  │                                                                │  │
│  │  Input: {                                                      │  │
│  │    html_dict: { tag: "p", hash: "abc123" },                   │  │
│  │    hash_mapping: { "abc123": "xxxx xx xxxxxxxx!" }            │  │
│  │  }                                                             │  │
│  │                                                                │  │
│  │  Output: <p>xxxx xx xxxxxxxx!</p>                             │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
Transformed HTML
```

### 4.2 Step-by-Step Process Details

#### Step 1: HTML to Hash Mapping

**Purpose**: Convert HTML to a structure-preserving format where text content is replaced with deterministic hashes.

**Key Points**:
- HTML structure (tags, attributes) is preserved in `html_dict`
- Text content is extracted and mapped to hashes
- Each unique text gets a unique hash
- Same text always gets same hash (deterministic)

**Example**:

```html
<!-- Input -->
<div>
  <h1>Welcome!</h1>
  <p>This is great content.</p>
</div>

<!-- Produces -->
{
  "html_dict": {
    "tag": "div",
    "children": [
      { "tag": "h1", "hash": "hash_001" },
      { "tag": "p", "hash": "hash_002" }
    ]
  },
  "hash_mapping": {
    "hash_001": "Welcome!",
    "hash_002": "This is great content."
  }
}
```

#### Step 2: Semantic Classification & Transformation

**Purpose**: Apply intelligent transformations based on semantic analysis.

**Process Flow**:

```
For each hash in hash_mapping:
    │
    ├─▶ [1] Classify Text
    │        │
    │        └─▶ Engine: AWS_COMPREHEND
    │            ├─▶ Call AWS Comprehend API
    │            ├─▶ Get sentiment scores:
    │            │   { positive: 0.92, negative: 0.02,
    │            │     neutral: 0.05, mixed: 0.01 }
    │            └─▶ Cache classification result
    │
    ├─▶ [2] Apply Filters
    │        │
    │        └─▶ Check criterion_filters:
    │            ├─▶ Filter 1: positive > 0.7?
    │            │   └─▶ 0.92 > 0.7 ✓ MATCH
    │            └─▶ Logic: AND/OR
    │                └─▶ Result: TRANSFORM
    │
    └─▶ [3] Apply Visual Transformation
             │
             └─▶ Mode: XXX
                 ├─▶ "Hello World" → "xxxxx xxxxx"
                 ├─▶ Preserve punctuation: "Hello!" → "xxxxx!"
                 └─▶ Preserve whitespace
```

**Transformation Modes**:

1. **XXX Mode**: Mask alphanumeric characters with 'x'
```
"Hello World!" → "xxxxx xxxxx!"
"Great content" → "xxxxx xxxxxxx"
```

2. **HASHES Mode**: Replace text with hash values
```
"Hello World!" → "abc123def456"
"Great content" → "xyz789uvw012"
```

3. **ABCDE_BY_SIZE Mode**: Group by text length, replace with letters
```
"Hi" (2 chars)      → "aa"
"Hello" (5 chars)   → "bbbbb"
"Welcome" (7 chars) → "ccccccc"
```

#### Step 3: Reconstruct HTML

**Purpose**: Rebuild HTML using transformed text while preserving structure.

**Process**:
- Take original `html_dict` structure
- Replace each hash with transformed text from `transformed_mapping`
- Reconstruct HTML tree
- Return complete transformed HTML

---

## 5. Service Integrations

### 5.1 HTML Service Integration

**Service**: `html.dev.mgraph.ai`  
**Component**: `HTML__Service__Client`

**Endpoints Used**:

```
POST /html/to/dict/hashes
├─ Input: { html: "<html>...</html>", max_depth: 256 }
└─ Output: { html_dict: {...}, hash_mapping: {...} }

POST /hashes/to/html
├─ Input: { html_dict: {...}, hash_mapping: {...} }
└─ Output: "<html>...</html>"
```

**Integration Flow**:

```
┌─────────────────────────────────────────────────────────────┐
│  HTML Transformation Service                                │
│  (HTML__Transformation__Service)                            │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│  HTML Service Client                                        │
│  (HTML__Service__Client)                                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Authentication                                       │  │
│  │  • Header: ENV[HTML_SERVICE__KEY_NAME]               │  │
│  │  • Value:  ENV[HTML_SERVICE__KEY_VALUE]              │  │
│  └───────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Request Handling                                     │  │
│  │  • Timeout: 30 seconds                                │  │
│  │  • Retry: None (fail fast)                            │  │
│  │  • Error handling: Return original HTML               │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│  HTML Service (External)                                    │
│  https://html.dev.mgraph.ai                                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Semantic Text Service Integration

**Service**: `semantic-text.dev.mgraph.ai`  
**Component**: `Semantic_Text__Service__Client`

**Endpoint Used**:

```
POST /text-transformation/transform
├─ Input: Schema__Semantic_Text__Transformation__Request
│   ├─ hash_mapping: Dict[hash → text]
│   ├─ engine_mode: Enum (AWS_COMPREHEND, TEXT_HASH, RANDOM)
│   ├─ criterion_filters: List[filter_config]
│   ├─ logic_operator: "AND" | "OR"
│   └─ transformation_mode: "XXX" | "HASHES" | "ABCDE_BY_SIZE"
│
└─ Output: Schema__Semantic_Text__Transformation__Response
    ├─ transformed_mapping: Dict[hash → transformed_text]
    ├─ total_hashes: int
    ├─ transformed_hashes: int
    └─ success: bool
```

**Classification Engine Modes**:

```
┌─────────────────────────────────────────────────────────────┐
│  1. AWS_COMPREHEND (ML-Based)                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  • Calls AWS Comprehend DetectSentiment API           │  │
│  │  • Returns: { positive, negative, neutral, mixed }    │  │
│  │  • Scores are 0.0-1.0 (sum to 1.0)                    │  │
│  │  • Cost: ~$0.0001 per request                         │  │
│  │  • Speed: ~200-500ms per request                      │  │
│  │  • Accuracy: High (trained on diverse data)           │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  2. TEXT_HASH (Deterministic)                               │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  • Uses hash of text as pseudo-random seed            │  │
│  │  • Same text always gets same classification          │  │
│  │  • No external API calls                              │  │
│  │  • Cost: $0                                            │  │
│  │  • Speed: <1ms per request                            │  │
│  │  • Accuracy: None (deterministic pseudo-random)       │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  3. RANDOM (Testing)                                        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  • Generates random sentiment scores                  │  │
│  │  • Different result each time                         │  │
│  │  • Used for testing/demos only                        │  │
│  │  • Cost: $0                                            │  │
│  │  • Speed: <1ms per request                            │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

**Multi-Criteria Filtering Example**:

```
Request:
{
  "hash_mapping": {
    "hash_001": "This is amazing!",
    "hash_002": "This is terrible.",
    "hash_003": "This is okay."
  },
  "engine_mode": "AWS_COMPREHEND",
  "criterion_filters": [
    { 
      "criterion": "positive",
      "filter_mode": "above",
      "threshold": 0.7
    }
  ],
  "logic_operator": "AND",
  "transformation_mode": "XXX"
}

Process:
┌────────────────────────────────────────────┐
│ hash_001: "This is amazing!"              │
│ ├─ Classify → positive: 0.95              │
│ ├─ 0.95 > 0.7? ✓ YES                      │
│ └─ Transform → "xxxx xx xxxxxxx!"         │
└────────────────────────────────────────────┘
┌────────────────────────────────────────────┐
│ hash_002: "This is terrible."             │
│ ├─ Classify → negative: 0.89              │
│ ├─ positive: 0.05 > 0.7? ✗ NO             │
│ └─ Keep original → "This is terrible."    │
└────────────────────────────────────────────┘
┌────────────────────────────────────────────┐
│ hash_003: "This is okay."                 │
│ ├─ Classify → neutral: 0.82               │
│ ├─ positive: 0.10 > 0.7? ✗ NO             │
│ └─ Keep original → "This is okay."        │
└────────────────────────────────────────────┘

Response:
{
  "transformed_mapping": {
    "hash_001": "xxxx xx xxxxxxx!",
    "hash_002": "This is terrible.",
    "hash_003": "This is okay."
  },
  "total_hashes": 3,
  "transformed_hashes": 1
}
```

### 5.3 Cache Service Integration

**Service**: `cache.dev.mgraph.ai`  
**Component**: `Proxy__Cache__Service`

**Key Concepts**:

```
┌─────────────────────────────────────────────────────────────┐
│  Cache Hierarchy                                            │
│                                                              │
│  Namespace: wcf-results                                     │
│  ├─ Page Entries (cache_id based)                          │
│  │   ├─ sites/{domain}/pages/{path}                        │
│  │   │   ├─ Metadata: { url, domain, path, created_at }    │
│  │   │   └─ cache_id: random-guid                          │
│  │   │                                                       │
│  │   └─ Data Files (per cache_id)                          │
│  │       ├─ original-html                                   │
│  │       │   └─ transformations/html                        │
│  │       │                                                   │
│  │       └─ transformation-{mode}                           │
│  │           ├─ transformations/html-xxx                    │
│  │           ├─ transformations/html-hashes                 │
│  │           └─ transformations/html-dict                   │
│  │                                                           │
│  └─ Statistics                                              │
│      ├─ cache_hits                                          │
│      ├─ cache_misses                                        │
│      └─ total_pages_cached                                  │
└─────────────────────────────────────────────────────────────┘
```

**Cache Flow**:

```
Request for: https://example.com/page.html with mitm-mode=xxx
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. Generate Cache Key                   │
│    URL → sites/example.com/pages/page   │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 2. Get or Create Page Entry             │
│    ├─ Check if page exists              │
│    ├─ If not, create new entry          │
│    └─ Return cache_id                   │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 3. Check for Transformation             │
│    Key: transformation-xxx               │
│    Path: transformations/html-xxx        │
│    ┌───────────────────────────────┐    │
│    │ Exists?                       │    │
│    └───┬───────────────────┬───────┘    │
│        │ Yes               │ No          │
│        ▼                   ▼             │
│    [Return]          [Transform & Store]│
└─────────────────────────────────────────┘
```

---

## 6. Transformation Modes & Engines

### 6.1 Transformation Modes (Visual Output)

```
┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=xxx                                      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  XXX Mode: Privacy Masking                            │  │
│  │  ├─ Masks alphanumeric characters                     │  │
│  │  ├─ Preserves punctuation                             │  │
│  │  ├─ Preserves whitespace                              │  │
│  │  └─ Maintains text structure                          │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "Hello, World! This is great."                       │  │
│  │  → "xxxxx, xxxxx! xxxx xx xxxxx."                     │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=hashes                                   │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  HASHES Mode: Hash Display                            │  │
│  │  ├─ Replaces text with hash value                     │  │
│  │  ├─ Same text = same hash                             │  │
│  │  └─ Useful for debugging/analysis                     │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "Hello, World!"                                       │  │
│  │  → "abc123def456789"                                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=abcde-by-size                            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  ABCDE_BY_SIZE Mode: Length-Based Grouping            │  │
│  │  ├─ Groups text by length                             │  │
│  │  ├─ 5 groups: a, b, c, d, e                           │  │
│  │  ├─ Same length = same letter                         │  │
│  │  └─ Reveals document structure                        │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "Hi" (2 chars)    → "aa"                             │  │
│  │  "Hello" (5 chars) → "bbbbb"                          │  │
│  │  "World" (5 chars) → "bbbbb"                          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 Classification Engines (Selection Logic)

```
┌─────────────────────────────────────────────────────────────┐
│  Engine: AWS_COMPREHEND                                     │
│  Use Case: Production sentiment analysis                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Workflow:                                             │  │
│  │  1. Send text to AWS Comprehend API                   │  │
│  │  2. Receive sentiment scores:                         │  │
│  │     { positive: 0.92, negative: 0.02,                 │  │
│  │       neutral: 0.05, mixed: 0.01 }                    │  │
│  │  3. Apply criterion filters                           │  │
│  │  4. Transform matched texts                           │  │
│  │                                                        │  │
│  │  Performance:                                          │  │
│  │  ├─ Latency: 200-500ms per request                    │  │
│  │  ├─ Cost: $0.0001 per text unit                       │  │
│  │  └─ Limit: 5000 chars per request                     │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Engine: TEXT_HASH                                          │
│  Use Case: Deterministic testing, cost-free demos           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Workflow:                                             │  │
│  │  1. Hash text content                                  │  │
│  │  2. Use hash as seed for pseudo-random scores         │  │
│  │  3. Generate repeatable sentiment scores              │  │
│  │  4. Apply filters and transform                       │  │
│  │                                                        │  │
│  │  Characteristics:                                      │  │
│  │  ├─ Same text → always same classification            │  │
│  │  ├─ No accuracy (not real sentiment)                  │  │
│  │  ├─ Instant (<1ms)                                     │  │
│  │  └─ Free (no API calls)                               │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Engine: RANDOM                                             │
│  Use Case: Testing, development only                        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Workflow:                                             │  │
│  │  1. Generate random scores for each text              │  │
│  │  2. Different result each time                        │  │
│  │  3. Apply filters and transform                       │  │
│  │                                                        │  │
│  │  Characteristics:                                      │  │
│  │  ├─ Same text → different results                     │  │
│  │  ├─ No accuracy (random)                              │  │
│  │  ├─ Instant (<1ms)                                     │  │
│  │  └─ Useful for testing filter logic                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 Sentiment-Based Filtering

**Configuration Format**:

```
{
  "engine_mode": "AWS_COMPREHEND",
  "criterion_filters": [
    {
      "criterion": "positive",     // positive|negative|neutral|mixed
      "filter_mode": "above",      // above|below
      "threshold": 0.7             // 0.0-1.0
    }
  ],
  "logic_operator": "AND",        // AND|OR (for multiple filters)
  "transformation_mode": "XXX"
}
```

**Common Filter Patterns**:

```
┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=xxx-negative                             │
│  Meaning: Mask text with high negative sentiment            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Filters:                                              │  │
│  │  └─ negative > 0.3                                     │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "This is terrible!" (negative: 0.85) → "xxxx xx xxxxxxxx!"│
│  │  "This is great!" (positive: 0.90)    → "This is great!"  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=xxx-hide-positive                        │
│  Meaning: Mask text with high positive sentiment            │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Filters:                                              │  │
│  │  └─ positive > 0.7                                     │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "This is great!" (positive: 0.90) → "xxxx xx xxxxx!" │  │
│  │  "This is bad." (negative: 0.85)   → "This is bad."   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode=xxx-hide-neutral                         │
│  Meaning: Mask text with neutral sentiment                  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Filters:                                              │  │
│  │  └─ neutral > 0.6                                      │  │
│  │                                                        │  │
│  │  Example:                                              │  │
│  │  "This is okay." (neutral: 0.75)  → "xxxx xx xxxx."   │  │
│  │  "This is great!" (positive: 0.90) → "This is great!" │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. Cache Architecture

### 7.1 Cache Structure

```
┌─────────────────────────────────────────────────────────────┐
│  Cache Service (cache.dev.mgraph.ai)                        │
│                                                              │
│  Storage Mode: S3 (with local memory fallback)              │
│  TTL: 720 hours (30 days)                                   │
│  Namespace: wcf-results                                     │
└─────────────────────────────────────────────────────────────┘

Cache Entry Structure:
────────────────────────
cache_id: random-guid-123
├─ Metadata (JSON)
│  ├─ cache_key: "sites/example.com/pages/article"
│  ├─ url: "https://example.com/article.html"
│  ├─ domain: "example.com"
│  ├─ path: "/article.html"
│  ├─ created_at: "2024-11-19T10:30:00Z"
│  ├─ last_accessed: "2024-11-19T12:45:00Z"
│  └─ access_count: 42
│
└─ Data Files
   ├─ original-html/transformations/html
   │  └─ Raw HTML (29.3 KB)
   │
   ├─ transformation-xxx/transformations/html-xxx
   │  ├─ Transformed HTML (29.3 KB)
   │  └─ metadata.json
   │     ├─ status_code: 200
   │     ├─ content_type: "text/html"
   │     ├─ cached_at: "2024-11-19T10:30:15Z"
   │     └─ transformation_time_ms: 1247.5
   │
   ├─ transformation-hashes/transformations/html-hashes
   │  └─ Transformed HTML (31.2 KB)
   │
   └─ transformation-abcde-by-size/transformations/html-abcde
      └─ Transformed HTML (29.0 KB)
```

### 7.2 Cache Key Generation

```
URL to Cache Key Conversion:
────────────────────────────

Input: https://docs.diniscruz.com/ai/llms/claude.html?ref=123

Step 1: Parse URL
├─ domain: docs.diniscruz.com
├─ path: /ai/llms/claude.html
└─ query: ref=123 (ignored)

Step 2: Sanitize Path
├─ Remove special chars: /ai/llms/claude-html
└─ Replace consecutive hyphens: /ai/llms/claude-html

Step 3: Build Cache Key
└─ sites/docs.diniscruz.com/pages/ai/llms/claude-html

Step 4: Generate Hash
└─ SHA-256(cache_key) → abc123...def789
```

### 7.3 Cache Lookup Flow

```
┌─────────────────────────────────────────────────────────────┐
│  Cache Lookup Decision Tree                                 │
└─────────────────────────────────────────────────────────────┘

Request: https://example.com/page.html with mitm-mode=xxx
    │
    ▼
┌─────────────────────────────┐
│ Is caching enabled?         │
└───┬─────────────────┬───────┘
    │ No              │ Yes
    ▼                 ▼
[Skip Cache]    ┌─────────────────────────┐
                │ Generate cache_key      │
                │ Generate cache_hash     │
                └───┬─────────────────────┘
                    │
                    ▼
                ┌─────────────────────────┐
                │ Does page entry exist?  │
                └───┬─────────────┬───────┘
                    │ No          │ Yes
                    ▼             ▼
        ┌───────────────────┐    ┌──────────────────────┐
        │ Create page entry │    │ Get cache_id         │
        │ Return cache_id   │    └──┬───────────────────┘
        └───────┬───────────┘       │
                │                   │
                └─────────┬─────────┘
                          ▼
                ┌─────────────────────────┐
                │ Check for transformation│
                │ data_key: trans-xxx     │
                └───┬─────────────┬───────┘
                    │ Not Found   │ Found
                    ▼             ▼
        ┌───────────────────┐    ┌──────────────────────┐
        │ Cache MISS        │    │ Cache HIT            │
        │ Increment miss    │    │ Increment hit        │
        │ Return None       │    │ Return HTML          │
        └───────────────────┘    └──────────────────────┘
```

### 7.4 Cache Storage Flow

```
┌─────────────────────────────────────────────────────────────┐
│  Cache Storage Process                                      │
└─────────────────────────────────────────────────────────────┘

Transformation Complete: xxx mode, 1247ms
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. Ensure Page Entry Exists             │
│    cache_key → cache_id                 │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 2. Store Original HTML (if first time)  │
│    data_file_id: original-html          │
│    data_key: transformations/html       │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 3. Store Transformed HTML                │
│    data_file_id: transformation-xxx      │
│    data_key: transformations/html-xxx    │
│    body: <transformed HTML>              │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 4. Store Metadata (optional)             │
│    data_key: trans-xxx/metadata          │
│    body: {                               │
│      status_code: 200,                   │
│      transformation_time_ms: 1247,       │
│      cached_at: "2024-11-19T..."         │
│    }                                     │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ 5. Update Statistics                     │
│    • total_pages_cached++                │
│    • transformation stored               │
└─────────────────────────────────────────┘
```

---

## 8. Cookie-Based Control

### 8.1 Cookie Architecture

**Design Decision**: Use cookies instead of URL parameters to:
- Avoid polluting URLs with debug parameters
- Enable control across multiple pages
- Persist settings across navigation
- Simplify URL sharing

### 8.2 Primary Control Cookie

```
┌─────────────────────────────────────────────────────────────┐
│  Cookie: mitm-mode                                          │
│  Purpose: Control HTML transformation behavior              │
│  Values: See transformation modes                           │
└─────────────────────────────────────────────────────────────┘

Set Cookie:
───────────
Set-Cookie: mitm-mode=xxx-negative; Path=/; Max-Age=3600; SameSite=Lax

Read Cookie:
────────────
Cookie: mitm-mode=xxx-negative

Processing Flow:
────────────────
Request Headers
    │
    ▼
┌─────────────────────────────────────────┐
│ Proxy__Cookie__Service                  │
│ ├─ Parse Cookie header                  │
│ ├─ Extract mitm-mode value              │
│ └─ Convert to Enum__HTML__Transform...  │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│ Enum__HTML__Transformation_Mode         │
│ ├─ OFF (no transformation)              │
│ ├─ XXX (mask text)                      │
│ ├─ XXX_NEGATIVE (mask negative)         │
│ ├─ XXX_HIDE_POSITIVE (mask positive)    │
│ ├─ HASHES (show hashes)                 │
│ ├─ ABCDE_BY_SIZE (group by length)      │
│ └─ ... (more modes)                     │
└─────────────────────────────────────────┘
```

### 8.3 Supported Cookie Values

```
┌─────────────────────────────────────────────────────────────┐
│  Basic Transformation Modes                                 │
├─────────────────────────────────────────────────────────────┤
│  off              → No transformation (pass through)        │
│  xxx              → Mask all text                           │
│  hashes           → Show hash values                        │
│  abcde-by-size    → Group by text length                    │
│  roundtrip        → Test HTML → dict → HTML                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Sentiment-Filtered Modes (AWS Comprehend)                  │
├─────────────────────────────────────────────────────────────┤
│  xxx-negative     → Mask negative sentiment (>0.3)          │
│  xxx-negative-1   → Mask negative sentiment (>0.1)          │
│  xxx-negative-2   → Mask negative sentiment (>0.2)          │
│  xxx-negative-3   → Mask negative sentiment (>0.3)          │
│  xxx-negative-4   → Mask negative sentiment (>0.4)          │
│  xxx-negative-05  → Mask negative sentiment (>0.05)         │
│                                                              │
│  xxx-hide-positive → Mask positive sentiment (>0.7)         │
│  xxx-hide-negative → Mask negative sentiment (>0.7)         │
│  xxx-hide-neutral  → Mask neutral sentiment (>0.6)          │
│  xxx-hide-mixed    → Mask mixed sentiment (>0.8)            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Random/Local Modes (No External Services)                  │
├─────────────────────────────────────────────────────────────┤
│  xxx-random       → Random masking (50%)                    │
│  hashes-random    → Random hash display (50%)               │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 Cookie Parsing Implementation

```
Security Features:
──────────────────

1. Type-Safe Parsing
   ├─ Safe_Str__Cookie_Name (max 256 chars)
   │  ├─ Alphanumeric, dots, underscores, hyphens only
   │  └─ Invalid chars → replaced with underscore
   │
   └─ Safe_Str__Cookie_Value (max 4096 chars)
      ├─ Control chars removed
      └─ Empty values allowed

2. Malformed Cookie Handling
   ├─ Supports both semicolon and comma separators
   ├─ Handles JSON values with braces/quotes
   ├─ Tracks parse errors for monitoring
   └─ Returns empty dict on failure

3. Injection Prevention
   ├─ No code execution from cookie values
   ├─ Enum validation for transformation modes
   └─ Unknown values → default to "off"
```

---

## 9. Configuration & Deployment

### 9.1 Environment Variables

```
┌─────────────────────────────────────────────────────────────┐
│  Required Environment Variables                             │
└─────────────────────────────────────────────────────────────┘

# Cache Service
AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL=https://cache.dev.mgraph.ai
AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_NAME=X-API-Key
AUTH__TARGET_SERVER__CACHE_SERVICE__KEY_VALUE=<secret>

# HTML Service
AUTH__TARGET_SERVER__HTML_SERVICE__BASE_URL=https://html.dev.mgraph.ai
AUTH__TARGET_SERVER__HTML_SERVICE__KEY_NAME=X-API-Key
AUTH__TARGET_SERVER__HTML_SERVICE__KEY_VALUE=<secret>

# Semantic Text Service
AUTH__TARGET_SERVER__SEMANTIC_TEXT_SERVICE__BASE_URL=https://semantic-text.dev.mgraph.ai
AUTH__TARGET_SERVER__SEMANTIC_TEXT_SERVICE__KEY_NAME=X-API-Key
AUTH__TARGET_SERVER__SEMANTIC_TEXT_SERVICE__KEY_VALUE=<secret>
```

### 9.2 Service Dependencies

```
┌─────────────────────────────────────────────────────────────┐
│  Python Dependencies (Lambda Layer)                         │
├─────────────────────────────────────────────────────────────┤
│  • mgraph_ai_service_cache_client==0.11.0                   │
│  • osbot-fast-api-serverless==1.29.0                        │
│  • osbot-utils (various type-safe utilities)                │
│  • requests (HTTP client)                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  External Service Dependencies                              │
├─────────────────────────────────────────────────────────────┤
│  HTML Service:                                              │
│  ├─ Timeout: 30 seconds                                     │
│  ├─ Required for: All transformations                       │
│  └─ Failure mode: Return original HTML                      │
│                                                              │
│  Semantic Text Service:                                     │
│  ├─ Timeout: 30 seconds                                     │
│  ├─ Required for: Sentiment-based filtering                 │
│  └─ Fallback: TEXT_HASH or RANDOM engine                    │
│                                                              │
│  Cache Service:                                             │
│  ├─ Timeout: 5 seconds                                      │
│  ├─ Optional: System works without cache                    │
│  └─ Failure mode: Bypass cache, continue processing         │
│                                                              │
│  AWS Comprehend (via Semantic Text Service):                │
│  ├─ Timeout: 30 seconds (handled by Semantic Text Service)  │
│  ├─ Required for: AWS_COMPREHEND engine mode                │
│  └─ Fallback: TEXT_HASH engine                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 AWS Lambda Deployment

```
┌─────────────────────────────────────────────────────────────┐
│  Lambda Configuration                                       │
├─────────────────────────────────────────────────────────────┤
│  Function Name: mgraph_ai_service_mitmproxy                 │
│  Runtime: Python 3.12                                       │
│  Handler: lambda_handler.run                                │
│  Memory: 512 MB                                             │
│  Timeout: 90 seconds                                        │
│  Architecture: x86_64                                       │
└─────────────────────────────────────────────────────────────┘

Deployment Process:
──────────────────
1. Package Dependencies
   ├─ Load from Lambda Layer (if available)
   └─ Bundle mgraph_ai_service_cache_client

2. Package Code
   ├─ mgraph_ai_service_mitmproxy/*
   ├─ mgraph_ai_service_mitmproxy__admin_ui/*
   └─ requirements.txt

3. Deploy to Lambda
   ├─ Create/update function
   ├─ Set environment variables
   └─ Configure API Gateway (optional)

4. Test Endpoints
   ├─ POST /proxy/process-request
   ├─ POST /proxy/process-response
   └─ GET /cache/health
```

---

## 10. Operational Monitoring

### 10.1 Statistics Tracking

```
┌─────────────────────────────────────────────────────────────┐
│  Proxy Statistics (Proxy__Stats__Service)                   │
├─────────────────────────────────────────────────────────────┤
│  • total_requests        → Count of requests processed      │
│  • total_responses       → Count of responses processed     │
│  • total_bytes_processed → Sum of response body sizes       │
│  • content_modifications → Count of transformations         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Cache Statistics (via /cache/stats endpoint)               │
├─────────────────────────────────────────────────────────────┤
│  • cache_hits               → Transformations from cache    │
│  • cache_misses             → Transformations generated     │
│  • hit_rate                 → cache_hits / (hits + misses)  │
│  • total_pages_cached       → Unique pages stored           │
│  • avg_cache_hit_time_ms    → Average cache lookup time     │
│  • avg_cache_miss_time_ms   → Average transformation time   │
│  • wcf_calls_saved          → Number of upstream calls saved│
└─────────────────────────────────────────────────────────────┘

Access via:
───────────
GET /cache/stats
GET /proxy/get-proxy-stats
GET /mitm-proxy/admin-ui.json
```

### 10.2 Response Headers (Debugging)

```
┌─────────────────────────────────────────────────────────────┐
│  Standard Response Headers                                  │
├─────────────────────────────────────────────────────────────┤
│  x-proxy-service          → "mgraph-proxy"                  │
│  x-proxy-version          → Service version                 │
│  x-request-id             → Unique request ID               │
│  x-processed-at           → ISO timestamp                   │
│  x-original-host          → Original upstream host          │
│  x-original-path          → Original request path           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Transformation Headers                                     │
├─────────────────────────────────────────────────────────────┤
│  x-proxy-transformation   → Transformation mode used        │
│  x-proxy-cache            → "hit" or "miss"                 │
│  x-html-service-time      → Transformation time (ms)        │
│  x-proxy-cookies          → Active cookie summary (JSON)    │
└─────────────────────────────────────────────────────────────┘

Example:
────────
HTTP/1.1 200 OK
content-type: text/html; charset=utf-8
x-proxy-service: mgraph-proxy
x-proxy-version: 0.6.0
x-proxy-transformation: xxx-negative
x-proxy-cache: miss
x-html-service-time: 1247.5ms
x-request-id: req-abc123
```

### 10.3 Admin Dashboard

```
┌─────────────────────────────────────────────────────────────┐
│  Admin UI (/mitm-proxy)                                     │
│  Static files served from mgraph_ai_service_mitmproxy__admin_ui
└─────────────────────────────────────────────────────────────┘

Available Endpoints:
───────────────────
GET  /mitm-proxy/                    → Redirect to latest version
GET  /mitm-proxy/v0/v0.1.1/index.html → Dashboard UI
GET  /mitm-proxy/admin-ui.json        → Live statistics (JSON API)

Dashboard Features:
──────────────────
├─ Real-time Statistics
│  ├─ Request/Response counts
│  ├─ Cache hit rate
│  ├─ Active transformations
│  └─ Service health
│
├─ Active Cookies Display
│  ├─ Current mitm-mode setting
│  ├─ All proxy control cookies
│  └─ Cookie values and counts
│
└─ Request Information
   ├─ Current request details
   ├─ Headers (sanitized)
   └─ Timestamp

Admin UI Data Structure:
───────────────────────
{
  "stats": {
    "total_requests": 1234,
    "cache_hit_rate": 0.67,
    ...
  },
  "cookies": {
    "active": { "mitm-mode": "xxx-negative" },
    "count": 1,
    "summary": { ... }
  },
  "request": {
    "host": "example.com",
    "path": "/page.html",
    "method": "GET"
  },
  "server": {
    "version": "0.6.0",
    "current_ui_version": "v0.1.1"
  },
  "timestamp": "2024-11-19T14:30:00Z"
}
```

### 10.4 Error Handling

```
┌─────────────────────────────────────────────────────────────┐
│  Error Handling Strategy                                    │
└─────────────────────────────────────────────────────────────┘

HTML Service Failure:
────────────────────
HTML Service timeout or error
    │
    ▼
┌─────────────────────────────────────────┐
│ Log error (non-fatal)                   │
│ Return original HTML (pass through)     │
│ Add header: x-transformation-error      │
└─────────────────────────────────────────┘

Semantic Text Service Failure:
──────────────────────────────
Semantic Text Service timeout
    │
    ▼
┌─────────────────────────────────────────┐
│ Fallback to TEXT_HASH engine           │
│ Continue transformation                 │
│ Add header: x-engine-fallback           │
└─────────────────────────────────────────┘

Cache Service Failure:
─────────────────────
Cache unavailable
    │
    ▼
┌─────────────────────────────────────────┐
│ Log warning (non-fatal)                 │
│ Skip cache lookup                       │
│ Perform transformation                  │
│ Skip cache storage                      │
│ Add header: x-cache-disabled            │
└─────────────────────────────────────────┘

Complete Transformation Failure:
────────────────────────────────
All steps fail
    │
    ▼
┌─────────────────────────────────────────┐
│ Return original HTML                    │
│ HTTP 200 (not an error to client)      │
│ Add headers:                            │
│ ├─ x-transformation-failed: true        │
│ └─ x-error-details: <error message>    │
└─────────────────────────────────────────┘
```

---

## Appendix A: Complete Request/Response Example

```
┌─────────────────────────────────────────────────────────────┐
│  End-to-End Example: Sentiment-Based Transformation         │
└─────────────────────────────────────────────────────────────┘

1. Browser Request
──────────────────
GET /article.html HTTP/1.1
Host: example.com
Cookie: mitm-mode=xxx-negative

2. Proxy Intercepts (mitmproxy addon)
──────────────────────────────────────
→ POST to FastAPI: /proxy/process-request

3. FastAPI Request Handler
───────────────────────────
├─ Parse cookie: mitm-mode=xxx-negative
├─ Check if admin path: No
├─ Add tracking headers
└─ Forward to upstream

4. Upstream Response (example.com)
───────────────────────────────────
HTTP/1.1 200 OK
Content-Type: text/html

<html>
<body>
  <h1>Product Review</h1>
  <p>This product is amazing!</p>
  <p>Terrible quality, very disappointed.</p>
  <p>It's okay for the price.</p>
</body>
</html>

5. Proxy Intercepts Response
─────────────────────────────
→ POST to FastAPI: /proxy/process-response

6. FastAPI Response Handler
────────────────────────────
├─ Extract mitm-mode: xxx-negative
├─ Parse mode: XXX_NEGATIVE
│  ├─ Transformation: XXX
│  ├─ Engine: AWS_COMPREHEND
│  └─ Filter: negative > 0.3
│
├─ Check cache: MISS
│
└─ Start transformation pipeline

7. Step 1: HTML → Hashes
────────────────────────
POST https://html.dev.mgraph.ai/html/to/dict/hashes

Response:
{
  "html_dict": { ... },
  "hash_mapping": {
    "h1": "Product Review",
    "p1": "This product is amazing!",
    "p2": "Terrible quality, very disappointed.",
    "p3": "It's okay for the price."
  }
}

8. Step 2: Classify & Transform
────────────────────────────────
POST https://semantic-text.dev.mgraph.ai/text-transformation/transform

Request:
{
  "hash_mapping": { ... },
  "engine_mode": "AWS_COMPREHEND",
  "criterion_filters": [
    { "criterion": "negative", "filter_mode": "above", "threshold": 0.3 }
  ],
  "transformation_mode": "XXX"
}

Processing:
├─ "Product Review"
│  ├─ AWS Comprehend: { neutral: 0.85 }
│  ├─ negative: 0.05 < 0.3 ✗
│  └─ Keep: "Product Review"
│
├─ "This product is amazing!"
│  ├─ AWS Comprehend: { positive: 0.92 }
│  ├─ negative: 0.03 < 0.3 ✗
│  └─ Keep: "This product is amazing!"
│
├─ "Terrible quality, very disappointed."
│  ├─ AWS Comprehend: { negative: 0.89 }
│  ├─ negative: 0.89 > 0.3 ✓
│  └─ Transform: "xxxxxxxx xxxxxxx, xxxx xxxxxxxxxxxx."
│
└─ "It's okay for the price."
   ├─ AWS Comprehend: { neutral: 0.76 }
   ├─ negative: 0.12 < 0.3 ✗
   └─ Keep: "It's okay for the price."

Response:
{
  "transformed_mapping": {
    "h1": "Product Review",
    "p1": "This product is amazing!",
    "p2": "xxxxxxxx xxxxxxx, xxxx xxxxxxxxxxxx.",
    "p3": "It's okay for the price."
  },
  "total_hashes": 4,
  "transformed_hashes": 1
}

9. Step 3: Hashes → HTML
─────────────────────────
POST https://html.dev.mgraph.ai/hashes/to/html

Response:
<html>
<body>
  <h1>Product Review</h1>
  <p>This product is amazing!</p>
  <p>xxxxxxxx xxxxxxx, xxxx xxxxxxxxxxxx.</p>
  <p>It's okay for the price.</p>
</body>
</html>

10. Store in Cache
──────────────────
Cache Service:
├─ cache_id: abc-123-def-456
├─ data_key: transformations/html-xxx-negative
└─ Store transformed HTML + metadata

11. Return to Browser
─────────────────────
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
x-proxy-transformation: xxx-negative
x-proxy-cache: miss
x-html-service-time: 1247.5ms

<html>
<body>
  <h1>Product Review</h1>
  <p>This product is amazing!</p>
  <p>xxxxxxxx xxxxxxx, xxxx xxxxxxxxxxxx.</p>
  <p>It's okay for the price.</p>
</body>
</html>

Result:
───────
✓ Only the negative text was masked
✓ Positive and neutral content preserved
✓ HTML structure maintained
✓ Transformation cached for future requests
```

---

## Appendix B: Transformation Mode Reference

| Cookie Value | Visual Mode | Engine | Filter | Description |
|-------------|-------------|--------|--------|-------------|
| `off` | - | - | - | No transformation (pass through) |
| `xxx` | XXX | TEXT_HASH | None | Mask all text deterministically |
| `xxx-random` | XXX | RANDOM | None | Mask 50% of text randomly |
| `xxx-negative` | XXX | AWS_COMPREHEND | negative>0.3 | Mask negative sentiment |
| `xxx-negative-1` | XXX | AWS_COMPREHEND | negative>0.1 | Mask negative (>0.1) |
| `xxx-negative-2` | XXX | AWS_COMPREHEND | negative>0.2 | Mask negative (>0.2) |
| `xxx-negative-4` | XXX | AWS_COMPREHEND | negative>0.4 | Mask negative (>0.4) |
| `xxx-hide-positive` | XXX | AWS_COMPREHEND | positive>0.7 | Mask positive sentiment |
| `xxx-hide-neutral` | XXX | AWS_COMPREHEND | neutral>0.6 | Mask neutral sentiment |
| `hashes` | HASHES | TEXT_HASH | None | Show hash values |
| `hashes-random` | HASHES | RANDOM | None | Show 50% as hashes |
| `abcde-by-size` | ABCDE | TEXT_HASH | None | Group by text length |

---

## Appendix C: Service Health Check

```bash
# Check Cache Service
curl https://cache.dev.mgraph.ai/info/health

# Check HTML Service  
curl https://html.dev.mgraph.ai/info/health

# Check Semantic Text Service
curl https://semantic-text.dev.mgraph.ai/info/health

# Check Proxy Service Cache Integration
curl https://mitmproxy.dev.mgraph.ai/cache/health

# Get Cache Statistics
curl https://mitmproxy.dev.mgraph.ai/cache/stats

# Get Proxy Statistics
curl https://mitmproxy.dev.mgraph.ai/proxy/get-proxy-stats
```

---

**Document Version:** v0.8.1  
**Last Updated:** November 19, 2024  
**Contact:** Technical Architecture Team
